# Development

## Build PHAR

`civix.phar` is usually compiled inside a [nix](https://nixos.org/download.html) shell, i.e.

```bash
nix-shell --run ./scripts/build.sh
```

To compile in another environment, use git and composer, e.g.:

You may also compile it manually in another environment -- if you have [`git`](https://git-scm.com),
[`composer`](https://getcomposer.org/), and [`box`](http://box-project.github.io/box2/):

```bash
git clone https://github.com/totten/civix
cd civix
composer install
box compile
```

__Tips__

* To match exact versions of the toolchain, consult [shell.nix](shell.nix) and the corresponding release of [buildkit pkgs](https://github.com/civicrm/civicrm-buildkit/blob/master/nix/pkgs/default.nix).
* `box` may require updating `php.ini`.

### Testing

Automated testing for `civix` requires a live CiviCRM deployment -- where it can generate and install example extensions.  The deployment
must be amenable to CLI scripting (eg `civix`, `cv`, `civibuild`).  You should set the environment variable `CIVIX_WORKSPACE` to point to
a folder where we can safely fill+destroy extensions, such as:

```bash
export CIVIX_WORKSPACE=$HOME/buildkit/build/dmaster/web/sites/all/modules/civicrm/ext/civixtest
```

Tests are divided into a few areas:

* PHPUnit: End-to-end tests (`tests/e2e/**Test.php`)
* PHPUnit: Unit tests (`src/CRM/CivixBundle/**Test.php`)
* Snapshots: Library of example extensions (`tests/snapshots/*`)

## Testing: PHPUnit

Ensure that the `CIVIX_WORKSPACE` is set before running phpunit. Also, ensure that there is clean database to test against.
For example:

```bash
export CIVIX_WORKSPACE=$HOME/buildkit/build/dmaster/web/sites/all/modules/civicrm/ext/civixtest
civibuild restore dmaster
phpunit8
```

The helper `./scripts/run-tests.sh` is a small wrapper which does the above.

## Testing: Snapshots

Snapshots are extensions generated by historical versions of civix.  The library of snapshots is used for E2E testing.
Working with snapshots is also a handy way to evaluate patches and see how civix behaves. There are several
scripts for working with snapshots.

```bash
export CIVIX_WORKSPACE=$HOME/buildkit/build/dmaster/web/sites/all/modules/civicrm/ext/civixtest

## Look at available snapshots
ls tests/snapshots/

## Run "civix upgrade" against the existing snapshots.
## Optionally, you may filter by name and increase verbosity.
./scripts/upgrade-snapshots.sh
./scripts/upgrade-snapshots.sh /entity34/
./scripts/upgrade-snapshots.sh /v22.10.2-entity34/
DEBUG=2 ./scripts/upgrade-snapshots.sh /v22.10.2-entity34/

## Review the output of "civix upgrade"
cd tests/snapshots/*/*v22.10.2-entity34*
less upgrade.log
zipdiff original.zip upgrade | colordiff | less -R
cd ../../../..

## Make new extensions with the current civix source-code.
## Save the snapshots for us to inspect.
./scripts/make-snapshots.sh --src

## As above, but also install and test the snapshots.
./scripts/make-snapshots.sh --src --test

## Make new snapshots and save for future reference.
./scripts/make-snapshots.sh --src --version v99.88
git add tests/snapshots/*v99.88*

## Remove any temporary data generated by the above.
./scripts/tidy-snapshots.sh
```
